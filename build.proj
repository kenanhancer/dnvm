<Project DefaultTargets="Publish">
  <Import Project="version.props" />
  <Import Project="build\git.targets" />

  <PropertyGroup>
    <Configuration>Debug</Configuration>
    <ArtifactsDir>$(MSBuildThisFileDirectory)artifacts\</ArtifactsDir>
    <TargetDir>$(ArtifactsDir)build\</TargetDir>
    <PublishDir>$(ArtifactsDir)$(Configuration)\</PublishDir>
    <PackageFileExtension>tar.gz</PackageFileExtension>
    <Version>$(VersionPrefix)</Version>
    <Version Condition="'$(VersionSuffix)'!=''">$(Version)-$(VersionSuffix)</Version>
    <RuntimeOs>osx-x64</RuntimeOs>
    <PackageFile>$(TargetDir)dnvm.$(RuntimeOs).$(Version).$(PackageFileExtension)</PackageFile>
  </PropertyGroup>

  <ItemGroup>
    <SourceProjects Include="src\*\*.*proj" />
    <TestProjects Include="test\*\*.Tests.csproj" />
    <TestProjects Include="test\*\*.FunctionalTests.csproj" />
    <Projects Include="@(SourceProjects);@(TestProjects)" />
    <Content Include="docs\releasenotes.md" PackagePath="%(FileName)%(Extension)" />
    <Content Include="packaging\README.md" PackagePath="%(FileName)%(Extension)" />
  </ItemGroup>

  <Target Name="Build" DependsOnTargets="ResolveCommitHash">
    <MSBuild Targets="Build"
             Projects="@(Projects)"
             Properties="Configuration=$(Configuration)" />
  </Target>

  <Target Name="VSTest">
    <MSBuild Projects="@(TestProjects)"
             Targets="VSTest"
             Properties="Configuration=$(Configuration)" />
  </Target>

  <Target Name="Publish" DependsOnTargets="CleanArtifacts;ResolveCommitHash">
    <MakeDir Directories="$(ArtifactsDir);$(PublishDir)bin\;$(TargetDir);" />
    <MSBuild Targets="Publish"
             Projects="@(SourceProjects)"
              Properties="Configuration=$(Configuration);PublishDir=$(PublishDir)libexec\" />
    <WriteLinesToFile File="$(PublishDir)version" Lines="$(CommitHash);$(Version)" />

    <Exec Command="ln -s ../libexec/dotnet ./dotnet"
          WorkingDirectory="$(PublishDir)bin\" />
    <Exec Command="ln -s ../libexec/dnvm ./dnvm"
          WorkingDirectory="$(PublishDir)bin\" />
    <Exec Command="ln -s ../libexec/dnvm-prompt ./dnvm-prompt"
          WorkingDirectory="$(PublishDir)bin\" />
    <Copy SourceFiles="%(Content.FullPath)" DestinationFiles="$(PublishDir)%(Content.PackagePath)" />

    <Exec Command="tar -zcf &quot;$(PackageFile)&quot; ."
          WorkingDirectory="$(PublishDir)"/>
    <Exec Command="du -hd 0 &quot;$(PublishDir)&quot; | awk '{print &quot;Uncompressed&quot;, $1}'" />
    <Exec Command="ls -S -lh | grep dnvm.* | awk '{print &quot;Compressed&quot;, $9, $5}'"
          WorkingDirectory="$(TargetDir)" />
    <Message Importance="high" Text="Created $(PackageFile)" />

  </Target>

  <Target Name="CleanArtifacts">
    <RemoveDir Directories="$(PublishDir);$(TargetDir);" />
  </Target>

  <Target Name="Clean"
          DependsOnTargets="CleanArtifacts">
    <MSBuild Targets="Clean"
             Projects="@(Projects)" />
  </Target>
</Project>
