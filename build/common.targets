<Project>
  <Import Project="git.targets" />
  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    <GenerateCommitHashAttribute Condition="'$(GenerateCommitHashAttribute)'==''">true</GenerateCommitHashAttribute>
    <GeneratedCommitHashAttributeFile Condition="'$(GeneratedCommitHashAttributeFile)'==''">$(IntermediateOutputPath)$(AssemblyName).CommitHash$(DefaultLanguageSourceExtension)</GeneratedCommitHashAttributeFile>
  </PropertyGroup>

<!--
********************************************************************************************
Target: GenerateCommitHashAttribute
Generates an assembly attribute with commit hash
********************************************************************************************
-->
  <Target Name="GenerateCommitHashAttribute"
          BeforeTargets="CoreCompile"
          DependsOnTargets="ResolveCommitHash;PrepareForBuild;GenerateIntermediateCommitHash;CoreGenerateCommitHashAttribute"
          Condition="'$(GenerateCommitHashAttribute)'=='true' and '$(DesignTimeBuild)'!='true' and '$(TargetFramework)'!=''" >
    <Warning Text="Property 'CommitHash' was not set"
             Condition="'$(CommitHash)'==''" />
  </Target>

  <Target Name="GenerateIntermediateCommitHash" Condition="'$(CommitHash)' != ''">
    <Touch Files="$(IntermediateOutputPath)$(CommitHash).commit.txt" AlwaysCreate="true" />
  </Target>

  <Target Name="CoreGenerateCommitHashAttribute"
          Condition="'$(CommitHash)'!='' and '$(GenerateCommitHashAttribute)'=='true'"
          Inputs="$(IntermediateCommitHash)"
          Outputs="$(GeneratedCommitHashAttributeFile)">

    <ItemGroup>
      <_CustomAttributes Remove="@(_CustomAttributes)" />
      <_CustomAttributes Include="System.Reflection.AssemblyMetadataAttribute">
        <_Parameter1>CommitHash</_Parameter1>
        <_Parameter2>$(CommitHash)</_Parameter2>
      </_CustomAttributes>
    </ItemGroup>

    <WriteCodeFragment AssemblyAttributes="@(_CustomAttributes)" Language="$(Language)" OutputFile="$(GeneratedCommitHashAttributeFile)">
      <Output TaskParameter="OutputFile" ItemName="Compile" />
      <Output TaskParameter="OutputFile" ItemName="FileWrites" />
    </WriteCodeFragment>

    <Message Importance="normal" Text="Generated commit hash attribute file $(GeneratedCommitHashAttributeFile)" />
  </Target>
</Project>